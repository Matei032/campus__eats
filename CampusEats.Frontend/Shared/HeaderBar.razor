@using CampusEats.Frontend.State
@using CampusEats.Frontend.Features.Auth
@inject AuthState AuthState
@inject AuthService AuthService
@inject NavigationManager Nav

<nav class="navbar navbar-expand bg-danger navbar-dark sticky-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">CampusEats</a>

    <ul class="navbar-nav me-auto mb-0">
      <li class="nav-item"><NavLink class="nav-link" href="/">Home</NavLink></li>
      <li class="nav-item"><NavLink class="nav-link" href="/menu">Menu</NavLink></li>
      <li class="nav-item"><NavLink class="nav-link" href="/cart">Cart</NavLink></li>
      <li class="nav-item"><NavLink class="nav-link" href="/orders">My Orders</NavLink></li>

      @if (IsStaffOrAdmin)
      {
        <li class="nav-item"><NavLink class="nav-link" href="/kitchen">Kitchen</NavLink></li>
        <li class="nav-item"><NavLink class="nav-link" href="/inventory">Inventory</NavLink></li>
      }

      @if (IsAdmin)
      {
        <li class="nav-item"><NavLink class="nav-link" href="/products-admin">Admin</NavLink></li>
      }
    </ul>

    <ul class="navbar-nav ms-auto mb-0">
      @if (!AuthState.IsAuthenticated)
      {
        <li class="nav-item me-2">
          <NavLink class="btn btn-sm btn-outline-light" href="/login">Sign in</NavLink>
        </li>
        <li class="nav-item">
          <NavLink class="btn btn-sm btn-light text-danger" href="/register">Register</NavLink>
        </li>
      }
      else
      {
        <li class="nav-item d-flex align-items-center me-3">
          <span class="navbar-text text-white-50">
            Signed in as <strong>@(string.IsNullOrWhiteSpace(AuthState.Username) ? "user" : AuthState.Username)</strong>
          </span>
        </li>
        <li class="nav-item">
          <button class="btn btn-sm btn-outline-light" @onclick="DoLogout">Logout</button>
        </li>
      }
    </ul>
  </div>
</nav>

@code {
  private bool IsStaffOrAdmin =>
      AuthState.Roles.Any(r => string.Equals(r, "Staff", StringComparison.OrdinalIgnoreCase) ||
                               string.Equals(r, "Admin", StringComparison.OrdinalIgnoreCase));

  private bool IsAdmin =>
      AuthState.Roles.Any(r => string.Equals(r, "Admin", StringComparison.OrdinalIgnoreCase));

  protected override void OnInitialized()
  {
      AuthService.AuthStateChanged += OnChanged;
      AuthState.Changed += OnChanged;
  }

  private void OnChanged() => InvokeAsync(StateHasChanged);

  private async Task DoLogout()
  {
      await AuthService.LogoutAsync();
      Nav.NavigateTo("/", forceLoad: true);
  }

  public void Dispose()
  {
      AuthService.AuthStateChanged -= OnChanged;
      AuthState.Changed -= OnChanged;
  }
}