@page "/order/{OrderId:guid}"
@inject ApiClient Api
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components

@code {
    [Parameter] public Guid OrderId { get; set; }

    // Accept userId din query: /order/{OrderId}?userId={Guid}
    [SupplyParameterFromQuery(Name = "userId")]
    public Guid? UserId { get; set; }

    OrderDto? _order;
    string? _msg;
    string? _error;
    bool _loading;

    // Câmp pentru introducere manuală userId când lipsește
    string _userIdText = "";

    protected override async Task OnParametersSetAsync()
    {
        if (UserId.HasValue)
        {
            await Load();
        }
    }

    async Task Load()
    {
        if (!UserId.HasValue)
        {
            _error = "Missing userId. Provide it below.";
            return;
        }

        _error = null;
        _loading = true;
        try
        {
            _order = await Api.GetOrderAsync(OrderId);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    async Task Cancel()
    {
        if (!UserId.HasValue)
        {
            _error = "Missing userId. Cannot cancel without user identity.";
            return;
        }

        try
        {
            await Api.CancelOrderAsync(OrderId, "Cancelled from UI");
            _msg = "Order cancelled.";
            _order = await Api.GetOrderAsync(OrderId);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    void ApplyUserId()
    {
        if (!Guid.TryParse(_userIdText, out var uid))
        {
            _error = "Invalid UserId";
            return;
        }

        // Navigăm la aceeași pagină dar cu ?userId=...
        Nav.NavigateTo($"/order/{OrderId}?userId={uid}");
    }
}

<h3 class="mb-3">Order Details</h3>

@if (!UserId.HasValue)
{
    <div class="alert alert-warning">
        This page requires a userId. Enter it below to continue.
    </div>
    <div class="input-group mb-3">
        <input class="form-control" placeholder="UserId (GUID)" @bind="_userIdText" />
        <button class="btn btn-danger" @onclick="ApplyUserId">Load</button>
    </div>
}
else if (_loading)
{
    <p>Loading…</p>
}
else if (_error is not null)
{
    <div class="alert alert-danger">@_error</div>
}
else if (_order is not null)
{
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <h5 class="card-title">#@_order.OrderNumber</h5>
                <span class="badge bg-secondary">@_order.Status</span>
            </div>
            <div class="small text-muted">@_order.CreatedAt:g</div>
        </div>
    </div>

    <ul class="list-group mb-3">
        @foreach (var it in _order.OrderItems)
        {
            <li class="list-group-item d-flex justify-content-between">
                <span>@it.ProductName × @it.Quantity</span>
                <span>@it.Subtotal.ToString("0.00") RON</span>
            </li>
        }
    </ul>

    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="/orders">Back</a>
        <button class="btn btn-outline-danger" @onclick="Cancel">Cancel order</button>
    </div>

    @if (_msg is not null)
    {
        <div class="alert alert-info mt-3">@_msg</div>
    }
}