@page "/profile"
@using CampusEats.Frontend.State
@using CampusEats.Frontend.Features.Auth
@inject AuthState AuthState
@inject HttpClient Http

<h2 class="mb-4 mt-3 fw-bold">Profil Utilizator</h2>

@if (!AuthState.IsAuthenticated)
{
<div class="alert alert-warning">Nu ești autentificat.</div>
}
else if (isLoading)
{
<p>Se încarcă...</p>
}
else
{
<!-- CARD: User Info -->
<div class="card shadow-sm mb-4 border-0 fade-in">
    <div class="card-body d-flex align-items-center">

        <!-- Avatar -->
        <div class="avatar-circle me-4">
            <span class="initials">@GetInitials(user.FullName)</span>
        </div>

        <div>
            <h5 class="fw-semibold mb-3">
                <i class="bi bi-person-circle me-2"></i>Informații utilizator
            </h5>

            <p><b>Nume:</b> @user.FullName</p>
            <p><b>Email:</b> @user.Email</p>
            <p><b>Rol:</b> @user.Role</p>
        </div>
    </div>
</div>

<!-- CARD: Loyalty Points -->
<div class="card shadow-sm mb-4 border-0 fade-in" style="animation-delay:.1s">
    <div class="card-body">

        <h5 class="fw-semibold mb-3">
            <i class="bi bi-stars me-2"></i>Puncte de loialitate
        </h5>

        <div class="d-flex align-items-baseline mb-2">
            <span class="display-5 fw-bold me-2">@loyaltyPoints</span>
            <span class="text-secondary">puncte</span>
        </div>

        <p class="text-muted">
            Valoare totală: <b>@loyaltyPointsRON.ToString("0.00") RON</b>
        </p>

        <p class="small text-muted mb-1">Total câștigate: @totalEarned</p>
        <p class="small text-muted">Total folosite: @totalRedeemed</p>

        <div class="progress mb-3" style="height:10px;">
            <div class="progress-bar bg-warning" role="progressbar"
                 style="width: @(Math.Min(loyaltyPoints,100))%;">
            </div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-warning w-50 fw-semibold" @onclick="Redeem50">
                Folosește 50 puncte
            </button>

            <button class="btn btn-secondary w-50 fw-semibold" @onclick="ToggleTransactions">
                Istoric tranzacții
            </button>
        </div>

        @if (!string.IsNullOrWhiteSpace(statusMessage))
        {
        <p class="mt-3 text-success fw-semibold">@statusMessage</p>
        }

        @if (transactionsVisible)
        {
            <hr class="my-4" />
            <h6 class="fw-bold mb-3">Tranzacții recente</h6>

            @if (transactions == null)
            {
                <p class="text-muted fst-italic">Se încarcă...</p>
            }
            else if (!transactions.Any())
            {
                <p class="text-muted fst-italic">Nu există tranzacții.</p>
            }
            else
            {
                <table class="table table-striped align-middle">
                    <thead>
                    <tr>
                        <th>Puncte</th>
                        <th>Tip</th>
                        <th>Descriere</th>
                        <th>Data</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var tx in transactions)
                    {
                        <tr>
                            <td class="fw-bold">@tx.PointsChange</td>
                            <td>@tx.Type</td>
                            <td>@tx.Description</td>
                            <td>@tx.CreatedAt.ToString("dd MMM yyyy, HH:mm")</td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
        }

    </div>
</div>

<!-- CARD: Orders -->
<div class="card shadow-sm mb-5 border-0 fade-in" style="animation-delay:.2s">
    <div class="card-body">
        <h5 class="fw-semibold mb-3">
            <i class="bi bi-bag-check me-2"></i>Comenzile mele
        </h5>

        @if (orders == null)
        {
        <p class="text-muted">Nu s-au putut încărca comenzile.</p>
        }
        else if (orders.Count == 0)
        {
        <p class="text-muted fst-italic">Nu ai comenzi.</p>
        }
        else
        {
        <ul class="list-group">
            @foreach (var order in orders)
            {
            <li class="list-group-item d-flex justify-content-between align-items-center fade-in-small">
                            <span>
                                <b>Comanda #@order.Id.ToString().Substring(0,6)</b>
                                <div class="text-muted small">@order.Status</div>
                            </span>

                <span class="fw-bold">@order.TotalAmount lei</span>
            </li>
            }
        </ul>
        }
    </div>
</div>
}

@code {
bool isLoading = true;
bool transactionsVisible = false;
bool isLoadingTransactions = false;

UserDto? user;

int loyaltyPoints;
decimal loyaltyPointsRON;
int totalEarned;
int totalRedeemed;

string statusMessage = "";

List<LoyaltyTransactionDto> transactions = new();
List<OrderDto> orders = new();

protected override async Task OnInitializedAsync()
{
if (!AuthState.IsAuthenticated)
return;

try
{
user = await Http.GetFromJsonAsync<UserDto>("/api/auth/me");

if (user != null)
{
var info = await Http.GetFromJsonAsync<LoyaltyPointsDto>("/api/loyalty/points");

if (info != null)
{
loyaltyPoints = info.CurrentPoints;
loyaltyPointsRON = info.PointsValue;
totalEarned = info.TotalEarned;
totalRedeemed = info.TotalRedeemed;
}

orders = await Http.GetFromJsonAsync<List<OrderDto>>
($"/api/orders/user/{user.Id}") ?? new();
}
}
catch { }

isLoading = false;
}

async Task Redeem50()
{
if (user == null) return;

var data = new { UserId = user.Id, PointsToRedeem = 50 };
var response = await Http.PostAsJsonAsync("/api/loyalty/redeem", data);

if (response.IsSuccessStatusCode)
{
loyaltyPoints -= 50;
loyaltyPointsRON = loyaltyPoints * 0.1m;
statusMessage = "Ai folosit 50 puncte.";
}
else
{
statusMessage = "Nu ai destule puncte.";
}
}

void ToggleTransactions()
{
transactionsVisible = !transactionsVisible;
if (transactionsVisible)
LoadTransactions();
}

async Task LoadTransactions()
{
    isLoadingTransactions = true;
    transactions = new();
    StateHasChanged(); // actualizează imediat mesajul "Se încarcă..."

    try
    {
        transactions =
            await Http.GetFromJsonAsync<List<LoyaltyTransactionDto>>(
                "/api/loyalty/transactions?page=1&pageSize=50"
            ) ?? new();
    }
    catch
    {
        transactions = new();
    }

    isLoadingTransactions = false;
    StateHasChanged();
}


string GetInitials(string name)
{
if (string.IsNullOrWhiteSpace(name)) return "?";
var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
return (parts[0][0].ToString() + parts[^1][0]).ToUpper();
}

public class LoyaltyPointsDto
{
public Guid UserId { get; set; }
public int CurrentPoints { get; set; }
public int TotalEarned { get; set; }
public int TotalRedeemed { get; set; }
public decimal PointsValue { get; set; }
}

public class LoyaltyTransactionDto
{
public Guid Id { get; set; }
public Guid UserId { get; set; }
public int PointsChange { get; set; }
public string Type { get; set; } = "";
public string Description { get; set; } = "";
public Guid? OrderId { get; set; }
public DateTime CreatedAt { get; set; }
}

public class UserDto
{
public Guid Id { get; set; }
public string FullName { get; set; } = "";
public string Email { get; set; } = "";
public string Role { get; set; } = "";
}

public class OrderDto
{
public Guid Id { get; set; }
public string Status { get; set; } = "";
public decimal TotalAmount { get; set; }
}
}

<style>
    .avatar-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #ffc107;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:32px;
        font-weight:bold;
        color:#333;
        box-shadow:0 2px 6px rgba(0,0,0,.15);
    }

    .fade-in {
        animation: fadeIn .5s ease forwards;
        opacity:0;
    }

    .fade-in-small {
        animation: fadeIn .4s ease forwards;
        opacity:0;
    }

    @@keyframes fadeIn {
        from { opacity:0; transform:translateY(10px); }
        to { opacity:1; transform:translateY(0); }
    }
</style>
