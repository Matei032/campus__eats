@page "/cart"
@using CampusEats.Frontend.Services
@using CampusEats.Frontend.Models
@using CampusEats.Frontend.Models.Requests
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Threading.Tasks

@inject CartService CartService
@inject ApiClient Api
@inject LoyaltyService LoyaltyService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@implements IDisposable

<PageTitle>Co»ôul Meu - CampusEats</PageTitle>

<div class="container mt-4">
    <h2 class="mb-4">Co»ôul de CumpƒÉrƒÉturi</h2>

    @if (CartService.Items.Count == 0)
    {
        <div class="alert alert-info text-center">
            Co»ôul tƒÉu este gol. <a href="menu" class="alert-link">Vezi Meniul</a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        @foreach (var item in CartService.Items)
                        {
                            <div class="d-flex justify-content-between align-items-center border-bottom py-3">
                                <div>
                                    <h5 class="mb-1">@item.Name</h5>
                                    <small class="text-muted">Pre»õ unitar: @item.UnitPrice. ToString("F2") RON</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <input type="number" class="form-control form-control-sm me-3" style="width: 70px;" 
                                           value="@item.Quantity" 
                                           min="1"
                                           @onchange="@(async (e) => await UpdateQty(item, e))" />
                            
                                    <button class="btn btn-outline-danger btn-sm" @onclick="async () => await CartService.Remove(item.ProductId)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Sumar ComandƒÉ</h5>
                    </div>
                    <div class="card-body">
                        <!-- Loyalty Points Display -->
                        @if (isLoadingPoints)
                        {
                            <div class="mb-3 text-center">
                                <div class="spinner-border spinner-border-sm text-warning"></div>
                                <small class="text-muted ms-2">Se √ÆncarcƒÉ punctele...</small>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning d-flex align-items-center mb-3" style="padding: 0.75rem;">
                                <i class="bi bi-stars fs-5 me-2"></i>
                                <div>
                                    <div><strong>Puncte disponibile:</strong> @availableLoyaltyPoints</div>
                                    <small class="text-muted">Valoare: @loyaltyPointsValue.ToString("F2") RON</small>
                                </div>
                            </div>
                        }

                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span class="fw-bold">@CartService.Total.ToString("F2") RON</span>
                        </div>

                        <!-- Loyalty Points Discount -->
                        @if (loyaltyPointsToUse > 0)
                        {
                            <div class="d-flex justify-content-between text-success mb-2">
                                <span>
                                    <i class="bi bi-dash-circle me-1"></i> Discount puncte:
                                </span>
                                <span class="fw-bold">-@GetLoyaltyDiscount().ToString("F2") RON</span>
                            </div>
                        }

                        <hr class="my-2" />

                        <div class="d-flex justify-content-between mb-3">
                            <span class="fw-bold">Total de platƒÉ:</span>
                            <span class="fw-bold text-primary fs-5">@GetFinalTotal().ToString("F2") RON</span>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">MetodƒÉ PlatƒÉ</label>
                            <select class="form-select" @bind="PaymentMethod" @bind:after="OnPaymentMethodChanged">
                                <option value="Cash">üíµ Cash la ridicare</option>
                                <option value="Card">üí≥ Card (Stripe)</option>
                                <option value="LoyaltyPoints">‚≠ê Puncte Loialitate</option>
                            </select>
                        </div>

                        <!-- Loyalty Points Slider -->
                        @if (PaymentMethod == "LoyaltyPoints" || showLoyaltySlider)
                        {
                            <div class="mb-3 p-3 bg-light rounded border">
                                <label class="form-label small fw-bold d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="bi bi-stars text-warning me-1"></i>
                                        Puncte de folosit:
                                    </span>
                                    <span class="badge bg-warning text-dark">@loyaltyPointsToUse puncte</span>
                                </label>
                                
                                <input type="range" 
                                       class="form-range" 
                                       min="0" 
                                       max="@GetMaxUsablePoints()"
                                       step="10"
                                       @bind="loyaltyPointsToUse"
                                       @bind:after="StateHasChanged" />
                                
                                <div class="d-flex justify-content-between small text-muted mt-1">
                                    <span>0</span>
                                    <span>@GetMaxUsablePoints()</span>
                                </div>
                                
                                <div class="mt-2 p-2 bg-white rounded small">
                                    <div class="d-flex justify-content-between">
                                        <span>Discount total:</span>
                                        <strong class="text-success">@GetLoyaltyDiscount().ToString("F2") RON</strong>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        <i class="bi bi-info-circle me-1"></i>1 punct = 0. 10 RON
                                    </small>
                                </div>
                            </div>

                            @if (PaymentMethod == "LoyaltyPoints" && GetFinalTotal() > 0)
                            {
                                <div class="alert alert-warning small py-2 mb-3">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    Punctele acoperƒÉ doar @GetLoyaltyDiscount().ToString("F2") RON.  
                                    Restul de <strong>@GetFinalTotal().ToString("F2") RON</strong> va fi plƒÉtit cash.
                                </div>
                            }
                        }

                        @if (PaymentMethod == "Card")
                        {
                            <div class="alert alert-info small py-2 mb-3">
                                <i class="bi bi-credit-card me-1"></i> 
                                Vei fi redirec»õionat cƒÉtre Stripe pentru platƒÉ securizatƒÉ.
                            </div>
                        }
                        else if (PaymentMethod == "LoyaltyPoints")
                        {
                            @if (GetFinalTotal() == 0)
                            {
                                <div class="alert alert-success small py-2 mb-3">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Comanda va fi plƒÉtitƒÉ 100% cu puncte de loialitate!  
                                </div>
                            }
                        }

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Observa»õii (Op»õional)</label>
                            <textarea class="form-control" rows="2" @bind="OrderNotes" 
                                      placeholder="Ex: FƒÉrƒÉ tac√¢muri, interfon 05... "></textarea>
                        </div>

                        @if (! string.IsNullOrEmpty(ErrorMessage))
                        {
                            <div class="alert alert-danger small py-2">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                @ErrorMessage
                            </div>
                        }

                        <button class="btn btn-success w-100 py-2 fw-semibold" 
                                @onclick="HandleCheckout" 
                                disabled="@IsProcessing">
                            @if (IsProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Se proceseazƒÉ...</span>
                            }
                            else
                            {
                                @if (PaymentMethod == "Card")
                                {
                                    <span><i class="bi bi-credit-card me-2"></i>ContinuƒÉ la PlatƒÉ</span>
                                }
                                else if (PaymentMethod == "LoyaltyPoints")
                                {
                                    <span><i class="bi bi-stars me-2"></i>PlƒÉte»ôte cu Puncte</span>
                                }
                                else
                                {
                                    <span><i class="bi bi-bag-check me-2"></i>FinalizeazƒÉ Comanda</span>
                                }
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string PaymentMethod = "Cash";
    private string OrderNotes = "";
    private bool IsProcessing = false;
    private bool isLoadingPoints = true;
    private string ErrorMessage = "";
    private int availableLoyaltyPoints = 0;
    private decimal loyaltyPointsValue = 0m;
    private int loyaltyPointsToUse = 0;
    private bool showLoyaltySlider = false;

    protected override async Task OnInitializedAsync()
    {
        CartService.OnChange += StateHasChanged;
        await LoadLoyaltyPoints();
    }

    private async Task LoadLoyaltyPoints()
    {
        try
        {
            isLoadingPoints = true;
            StateHasChanged();

            var loyaltyInfo = await LoyaltyService. GetLoyaltyInfo();
            
            if (loyaltyInfo != null)
            {
                availableLoyaltyPoints = loyaltyInfo.CurrentPoints;
                loyaltyPointsValue = loyaltyInfo. PointsValue;
                
                Console.WriteLine($"‚úÖ Loyalty loaded: {availableLoyaltyPoints} points = {loyaltyPointsValue:F2} RON");
            }
            else
            {
                availableLoyaltyPoints = 0;
                loyaltyPointsValue = 0m;
                Console.WriteLine("‚ö†Ô∏è No loyalty info returned");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading loyalty: {ex.Message}");
            availableLoyaltyPoints = 0;
            loyaltyPointsValue = 0m;
        }
        finally
        {
            isLoadingPoints = false;
            StateHasChanged();
        }
    }

    private void OnPaymentMethodChanged()
    {
        if (PaymentMethod == "LoyaltyPoints")
        {
            showLoyaltySlider = true;
            loyaltyPointsToUse = GetMaxUsablePoints();
        }
        else
        {
            showLoyaltySlider = false;
            loyaltyPointsToUse = 0;
        }
        StateHasChanged();
    }

    private int GetMaxUsablePoints()
    {
        // 1 punct = 0.10 RON, deci pentru 8. 00 RON ‚Üí max 80 puncte
        var cartTotalInPoints = (int)Math.Floor(CartService.Total / 0.1m);
        var maxPoints = Math.Min(availableLoyaltyPoints, cartTotalInPoints);
        
        Console.WriteLine($"üìä Cart: {CartService.Total:F2} RON ‚Üí max {cartTotalInPoints} points.  Available: {availableLoyaltyPoints}.  Using: {maxPoints}");
        
        return maxPoints;
    }

    private decimal GetLoyaltyDiscount()
    {
        return loyaltyPointsToUse * 0.1m; // 1 punct = 0.10 RON
    }

    private decimal GetFinalTotal()
    {
        var total = CartService.Total - GetLoyaltyDiscount();
        return Math.Max(0, total);
    }

    public void Dispose()
    {
        CartService.OnChange -= StateHasChanged;
    }

    private async Task UpdateQty(CartItem item, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?. ToString(), out int qty) && qty > 0)
        {
            await CartService. UpdateQty(item.ProductId, qty);
            
            // RecalculeazƒÉ loyalty points dacƒÉ suntem √Æn modul de platƒÉ cu puncte
            if (PaymentMethod == "LoyaltyPoints")
            {
                var maxUsable = GetMaxUsablePoints();
                loyaltyPointsToUse = Math.Min(loyaltyPointsToUse, maxUsable);
                StateHasChanged();
            }
        }
    }

    private async Task HandleCheckout()
    {
        IsProcessing = true;
        ErrorMessage = "";

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?. IsAuthenticated != true)
        {
            ErrorMessage = "Trebuie sƒÉ fii autentificat pentru a plasa comanda.";
            IsProcessing = false;
            return;
        }

        var userIdClaim = user.FindFirst(c => c.Type == "sub") ??  
                          user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
        
        if (userIdClaim == null || ! Guid.TryParse(userIdClaim.Value, out Guid userId))
        {
            ErrorMessage = "Eroare de sesiune. Te rugƒÉm sƒÉ te reloghezi.";
            IsProcessing = false;
            return;
        }

        // Validare loyalty points
        if (PaymentMethod == "LoyaltyPoints")
        {
            if (loyaltyPointsToUse > availableLoyaltyPoints)
            {
                ErrorMessage = $"Nu ai suficiente puncte.  Disponibile: {availableLoyaltyPoints}, selectate: {loyaltyPointsToUse}";
                IsProcessing = false;
                return;
            }

            if (loyaltyPointsToUse == 0)
            {
                ErrorMessage = "SelecteazƒÉ c√¢te puncte vrei sƒÉ folose»ôti (minim 10).";
                IsProcessing = false;
                return;
            }
        }

        var command = new CreateOrderCommand
        {
            UserId = userId,
            PaymentMethod = PaymentMethod,
            Notes = OrderNotes,
            Items = CartService. Items. Select(i => new OrderItemRequest
            {
                ProductId = i.ProductId,
                Quantity = i.Quantity,
                SpecialInstructions = ""
            }).ToList()
        };

        try 
        {
            var order = await Api. CreateOrderAsync(command);
            
            if (order == null)
            {
                ErrorMessage = "Nu am putut plasa comanda.  VerificƒÉ consola pentru detalii.";
                IsProcessing = false;
                return;
            }

            // Procesare √Æn func»õie de metoda de platƒÉ
            if (PaymentMethod == "Cash")
            {
                await CartService.Clear();
                NavigationManager.NavigateTo("/orders");
            }
            else if (PaymentMethod == "Card")
            {
                await CartService.Clear();
                NavigationManager.NavigateTo($"/checkout/{order.Id}");
            }
            else if (PaymentMethod == "LoyaltyPoints")
            {
                var paymentRequest = new ProcessPaymentRequest
                {
                    OrderId = order.Id,
                    PaymentMethod = "LoyaltyPoints",
                    Amount = CartService.Total,
                    LoyaltyPointsUsed = loyaltyPointsToUse
                };

                var paymentResult = await Api.ProcessPaymentAsync(paymentRequest);

                if (paymentResult != null)
                {
                    await CartService.Clear();
                    NavigationManager.NavigateTo("/orders");
                }
                else
                {
                    ErrorMessage = "Eroare la procesarea plƒÉ»õii cu puncte de loialitate.";
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Eroare: {ex.Message}";
            Console.WriteLine($"‚ùå Checkout error: {ex}");
        }
        finally
        {
            IsProcessing = false;
        }
    }
}