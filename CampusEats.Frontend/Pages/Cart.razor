@page "/cart"
@using CampusEats.Frontend.Services
@using CampusEats.Frontend.Models
@using CampusEats.Frontend.Models.Requests
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Threading.Tasks

@inject CartService CartService
@inject ApiClient Api
@inject LoyaltyService LoyaltyService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@implements IDisposable

<PageTitle>Coșul Meu - CampusEats</PageTitle>

<div class="container mt-4">
    <h2 class="mb-4">Coșul de Cumpărături</h2>

    @if (CartService.Items.Count == 0)
    {
        <div class="alert alert-info text-center">
            Coșul tău este gol. <a href="menu" class="alert-link">Vezi Meniul</a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        @foreach (var item in CartService.Items)
                        {
                            <div class="d-flex justify-content-between align-items-center border-bottom py-3">
                                <div>
                                    <h5 class="mb-1">@item.Name</h5>
                                    <small class="text-muted">Preț unitar: @item.UnitPrice.ToString("F2") RON</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <input type="number" class="form-control form-control-sm me-3" style="width: 70px;" 
                                           value="@item.Quantity" 
                                           min="1"
                                           @onchange="@(async (e) => await UpdateQty(item, e))" />
                            
                                    <button class="btn btn-outline-danger btn-sm" @onclick="async () => await CartService.Remove(item.ProductId)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Sumar Comandă</h5>
                    </div>
                    <div class="card-body">
                        <!-- Loyalty Points Display -->
                        @if (isLoadingPoints)
                        {
                            <div class="mb-3 text-center">
                                <div class="spinner-border spinner-border-sm text-warning"></div>
                                <small class="text-muted ms-2">Se încarcă punctele...</small>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning d-flex align-items-center mb-3" style="padding: 0.75rem;">
                                <i class="bi bi-stars fs-5 me-2"></i>
                                <div>
                                    <div><strong>Puncte disponibile:</strong> @availableLoyaltyPoints.ToString("F2")</div>
                                    <small class="text-muted">Valoare: @loyaltyPointsValue.ToString("F2") RON</small>
                                </div>
                            </div>
                        }

                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span class="fw-bold">@CartService.Total.ToString("F2") RON</span>
                        </div>

                        <!-- Loyalty Points Discount -->
                        @if (useLoyaltyPoints && loyaltyPointsToUse > 0)
                        {
                            <div class="d-flex justify-content-between text-success mb-2">
                                <span>
                                    <i class="bi bi-dash-circle me-1"></i> Discount puncte:
                                </span>
                                <span class="fw-bold">-@GetLoyaltyDiscount().ToString("F2") RON</span>
                            </div>
                        }

                        <hr class="my-2" />

                        <div class="d-flex justify-content-between mb-3">
                            <span class="fw-bold">Total de plată:</span>
                            <span class="fw-bold text-primary fs-5">@GetFinalTotal().ToString("F2") RON</span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="useLoyaltyPoints" 
                                       @bind="useLoyaltyPoints" 
                                       @bind:after="OnLoyaltyToggleChanged"
                                       disabled="@(availableLoyaltyPoints < 1)">
                                <label class="form-check-label" for="useLoyaltyPoints">
                                    Folosește Puncte Loialitate (@availableLoyaltyPoints.ToString("F2") disponibile)
                                </label>
                            </div>

                            @if (useLoyaltyPoints)
                            {
                                <div class="p-3 bg-light rounded border mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small fw-bold">
                                            <i class="bi bi-stars text-warning me-1"></i>
                                            Puncte folosite:
                                        </span>
                                        <span class="badge bg-warning text-dark">@loyaltyPointsToUse.ToString("F2")</span>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center small bg-white p-2 rounded">
                                        <span>Discount aplicat:</span>
                                        <strong class="text-success">@GetLoyaltyDiscount().ToString("F2") RON</strong>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Metodă Plată (Rest de plată: @GetFinalTotal().ToString("F2") RON)</label>
                            <select class="form-select" @bind="PaymentMethod">
                                <option value="Cash">Cash la ridicare</option>
                                <option value="Card">Card (Stripe)</option>
                            </select>
                        </div>

                        @if (PaymentMethod == "Card" && GetFinalTotal() > 0)
                        {
                            <div class="alert alert-info small py-2 mb-3">
                                <i class="bi bi-credit-card me-1"></i> 
                                Vei fi redirecționat către Stripe pentru plata restului de @GetFinalTotal().ToString("F2") RON.
                            </div>
                        }

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Observații (Opțional)</label>
                            <textarea class="form-control" rows="2" @bind="OrderNotes" 
                                      placeholder="Ex: Fără tacâmuri, interfon 05... "></textarea>
                        </div>

                        @if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <div class="alert alert-danger small py-2">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                @ErrorMessage
                            </div>
                        }

                        <button class="btn btn-success w-100 py-2 fw-semibold" 
                                @onclick="HandleCheckout" 
                                disabled="@IsProcessing">
                            @if (IsProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Se procesează...</span>
                            }
                            else
                            {
                                <span><i class="bi bi-bag-check me-2"></i>Finalizează Comanda</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string PaymentMethod = "Cash";
    private string OrderNotes = "";
    private bool IsProcessing = false;
    private bool isLoadingPoints = true;
    private string ErrorMessage = "";
    private decimal availableLoyaltyPoints = 0;
    private decimal loyaltyPointsValue = 0m;
    private bool useLoyaltyPoints = false;
    private decimal loyaltyPointsToUse = 0;

    protected override async Task OnInitializedAsync()
    {
        CartService.OnChange += StateHasChanged;
        await LoadLoyaltyPoints();
    }

    private async Task LoadLoyaltyPoints()
    {
        try
        {
            isLoadingPoints = true;
            StateHasChanged();

            var loyaltyInfo = await LoyaltyService.GetLoyaltyInfo();
            
            if (loyaltyInfo != null)
            {
                availableLoyaltyPoints = loyaltyInfo.CurrentPoints;
                loyaltyPointsValue = loyaltyInfo.PointsValue;
            }
            else
            {
                availableLoyaltyPoints = 0;
                loyaltyPointsValue = 0m;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading loyalty: {ex.Message}");
            availableLoyaltyPoints = 0;
        }
        finally
        {
            isLoadingPoints = false;
            StateHasChanged();
        }
    }

    private void OnLoyaltyToggleChanged()
    {
        if (useLoyaltyPoints)
        {
            loyaltyPointsToUse = GetMaxUsablePoints();
        }
        else
        {
            loyaltyPointsToUse = 0;
        }
        StateHasChanged();
    }

    private decimal GetMaxUsablePoints()
    {
        // 1 punct = 1 RON
        // Putem folosi maxim cat e totalul comenzii sau cat avem disponibil
        var maxPoints = Math.Min(availableLoyaltyPoints, CartService.Total);
        return maxPoints;
    }

    private decimal GetLoyaltyDiscount()
    {
        if (!useLoyaltyPoints) return 0m;
        return loyaltyPointsToUse * 1.0m;
    }

    private decimal GetFinalTotal()
    {
        var total = CartService.Total - GetLoyaltyDiscount();
        return Math.Max(0, total);
    }

    public void Dispose()
    {
        CartService.OnChange -= StateHasChanged;
    }

    private async Task UpdateQty(CartItem item, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int qty) && qty > 0)
        {
            await CartService.UpdateQty(item.ProductId, qty);
            
            if (useLoyaltyPoints)
            {
                // Recalculăm automat punctele folosite dacă se schimbă totalul
                loyaltyPointsToUse = GetMaxUsablePoints();
                StateHasChanged();
            }
        }
    }

    private async Task HandleCheckout()
    {
        IsProcessing = true;
        ErrorMessage = "";

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            ErrorMessage = "Trebuie să fii autentificat pentru a plasa comanda.";
            IsProcessing = false;
            return;
        }

        var userIdClaim = user.FindFirst(c => c.Type == "sub") ??  
                          user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier);
        
        if (userIdClaim == null || !Guid.TryParse(userIdClaim.Value, out Guid userId))
        {
            ErrorMessage = "Eroare de sesiune. Te rugăm să te reloghezi.";
            IsProcessing = false;
            return;
        }

        // Create Order Command
        // We initially send PaymentMethod as the "Primary" method (e.g. Card/Cash), 
        // even if we partially pay with Loyalty.
        
        var command = new CreateOrderCommand
        {
            UserId = userId,
            PaymentMethod = PaymentMethod, 
            Notes = OrderNotes,
            Items = CartService.Items.Select(i => new OrderItemRequest
            {
                ProductId = i.ProductId,
                Quantity = i.Quantity,
                SpecialInstructions = ""
            }).ToList()
        };

        try 
        {
            var order = await Api.CreateOrderAsync(command);
            
            if (order == null)
            {
                ErrorMessage = "Nu am putut plasa comanda. Verifică consola pentru detalii.";
                IsProcessing = false;
                return;
            }

            // 1. Process Loyalty Payment (if selected)
            if (useLoyaltyPoints && loyaltyPointsToUse > 0)
            {
                var loyaltyPayment = new ProcessPaymentRequest
                {
                    OrderId = order.Id,
                    PaymentMethod = "LoyaltyPoints",
                    Amount = GetLoyaltyDiscount(),
                    LoyaltyPointsUsed = loyaltyPointsToUse
                };

                var loyaltyResult = await Api.ProcessPaymentAsync(loyaltyPayment);
                if (loyaltyResult == null)
                {
                    Console.WriteLine("⚠️ Loyalty payment failed.");
                }
            }

            // 2. Process Remaining Balance
            var remainingAmount = GetFinalTotal();

            if (remainingAmount > 0)
            {
                if (PaymentMethod == "Card")
                {
                    var cardPayment = new ProcessPaymentRequest
                    {
                        OrderId = order.Id,
                        PaymentMethod = "Card",
                        Amount = remainingAmount
                    };

                    var cardResult = await Api.ProcessPaymentAsync(cardPayment);
                    if (cardResult?.StripeClientSecret != null)
                    {
                        await CartService.Clear();
                        NavigationManager.NavigateTo(cardResult.StripeClientSecret, forceLoad: true);
                        return;
                    }
                    else
                    {
                        ErrorMessage = "Eroare la inițierea plății cu cardul.";
                    }
                }
                else // Cash
                {
                    var cashPayment = new ProcessPaymentRequest
                    {
                        OrderId = order.Id,
                        PaymentMethod = "Cash",
                        Amount = remainingAmount
                    };
                    await Api.ProcessPaymentAsync(cashPayment);
                    
                    await CartService.Clear();
                    NavigationManager.NavigateTo("/profile");
                }
            }
            else
            {
                // Covered fully by Loyalty
                await CartService.Clear();
                NavigationManager.NavigateTo("/profile");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Eroare: {ex.Message}";
            Console.WriteLine($"Checkout error: {ex}");
        }
        finally
        {
            IsProcessing = false;
        }
    }
}