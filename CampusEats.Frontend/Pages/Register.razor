@page "/register"
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Nav
@inject CampusEats.Frontend.Features.Auth.AuthService Auth

<h3>Create account</h3>

@if (_errors.Count > 0)
{
    <div class="alert alert-danger">
        <ul class="mb-0">
            @foreach (var e in _errors)
            {
                <li>@e</li>
            }
        </ul>
    </div>
}

<EditForm Model="_model" OnValidSubmit="OnSubmit">
    <DataAnnotationsValidator />
    <div class="mb-3">
        <label class="form-label">Full name</label>
        <InputText class="form-control" @bind-Value="_model.FullName" />
        <ValidationMessage For="@(() => _model.FullName)" />
    </div>
    <div class="mb-3">
        <label class="form-label">Email</label>
        <InputText class="form-control" @bind-Value="_model.Email" />
        <ValidationMessage For="@(() => _model.Email)" />
    </div>
    <div class="mb-3">
        <label class="form-label">Password</label>
        <InputText type="password" class="form-control" @bind-Value="_model.Password" />
        <ValidationMessage For="@(() => _model.Password)" />
    </div>
    <div class="mb-3">
        <label class="form-label">Confirm password</label>
        <InputText type="password" class="form-control" @bind-Value="_model.ConfirmPassword" />
        <ValidationMessage For="@(() => _model.ConfirmPassword)" />
    </div>

    <button class="btn btn-danger" disabled="@_busy">
        @(_busy ? "Creating..." : "Create account")
    </button>
</EditForm>

@code {
    private readonly RegisterModel _model = new();
    private readonly List<string> _errors = new();
    private bool _busy;

    private async Task OnSubmit()
    {
        _errors.Clear();

        if (_model.Password != _model.ConfirmPassword)
        {
            _errors.Add("Passwords do not match.");
            return;
        }

        _busy = true;
        try
        {
            // IMPORTANT: 3 argumente (email, password, fullName)
            var (ok, errs) = await Auth.RegisterAsync(_model.Email, _model.Password, _model.FullName);
            if (!ok)
            {
                _errors.AddRange(errs);
                return;
            }

            // Dacă backend-ul nu întoarce token la register, vei fi considerat neautentificat după register.
            // Poți redirecționa la /login sau la home. Alege una:
            Nav.NavigateTo("/");
            // Nav.NavigateTo("/login");
        }
        finally
        {
            _busy = false;
        }
    }

    public class RegisterModel
    {
        [Required, StringLength(100)]
        public string FullName { get; set; } = string.Empty;

        [Required, EmailAddress, StringLength(100)]
        public string Email { get; set; } = string.Empty;

        [Required, StringLength(100, MinimumLength = 6)]
        public string Password { get; set; } = string.Empty;

        [Required, StringLength(100, MinimumLength = 6)]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}