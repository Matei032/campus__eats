@page "/register"
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@using CampusEats.Frontend.Models.Auth

<h3>Înregistrare Cont Nou</h3>

<div class="row justify-content-center">
    <div class="col-md-6">
        <EditForm Model="@RegisterModel" OnValidSubmit="@HandleRegister">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label>Nume Complet</label>
                <InputText @bind-Value="RegisterModel.FullName" class="form-control" placeholder="Ion Popescu" />
            </div>

            <div class="mb-3">
                <label>Email</label>
                <InputText @bind-Value="RegisterModel.Email" class="form-control" placeholder="ion@student.tuiasi.ro" />
            </div>

            <div class="mb-3">
                <label>Număr Telefon</label>
                <InputText @bind-Value="RegisterModel.PhoneNumber" class="form-control" />
            </div>

            <div class="mb-3">
                <label>ID Student (Opțional)</label>
                <InputText @bind-Value="RegisterModel.StudentId" class="form-control" />
            </div>

            <div class="mb-3">
                <label>Parolă</label>
                <InputText @bind-Value="RegisterModel.Password" type="password" class="form-control" />
            </div>
            
            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="alert alert-success text-center">
                    <i class="bi bi-check-circle-fill me-2"></i> @SuccessMessage
                </div>
            }
            
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger">@ErrorMessage</div>
            }

            <button type="submit" class="btn btn-primary w-100" disabled="@IsLoading">
                @(IsLoading ? "Se creează contul..." : "Înregistrează-te")
            </button>
        </EditForm>
    </div>
</div>

@code {
    private RegisterRequest RegisterModel = new RegisterRequest();
    private bool IsLoading = false;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty; // <--- Variabilă nouă

    private async Task HandleRegister()
    {
        IsLoading = true;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;

        // Validare simplă
        if (string.IsNullOrWhiteSpace(RegisterModel.FullName) || 
            string.IsNullOrWhiteSpace(RegisterModel.Email) || 
            string.IsNullOrWhiteSpace(RegisterModel.Password))
        {
            ErrorMessage = "Te rog completează toate câmpurile obligatorii.";
            IsLoading = false;
            return;
        }

        var (success, errors) = await AuthService.RegisterAsync(RegisterModel);

        if (success)
        {
            // 1. Afișăm mesajul de succes
            SuccessMessage = "Contul a fost creat cu succes! Te redirecționăm...";
            StateHasChanged(); // Forțăm actualizarea interfeței
            
            // 2. Așteptăm 2 secunde
            await Task.Delay(2000);

            // 3. Redirecționăm la Login
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            if (errors.Any())
            {
                ErrorMessage = string.Join(", ", errors);
            }
            else
            {
                ErrorMessage = "A apărut o eroare la înregistrare.";
            }
        }

        IsLoading = false;
    }
}