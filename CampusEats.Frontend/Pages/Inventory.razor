@page "/inventory"
@using System.Globalization
@using CampusEats.Frontend.Services
@using CampusEats.Frontend.Models
@inject ApiClient Api

<h3>Inventory â€“ Daily report</h3>

<div class="row g-3 align-items-end mb-3">
    <div class="col-auto">
        <label class="form-label">Report date</label>
        <InputDate @bind-Value="selectedDate" class="form-control" />
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" @onclick="Load">Load</button>
    </div>
</div>

@if (loading)
{
    <div>Loading...</div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (report is null)
{
    <div class="alert alert-info">No report.</div>
}
else
{
    <div class="row mb-3">
        <div class="col-auto">
            <strong>Total orders:</strong> @report.TotalOrdersProcessed
        </div>
        <div class="col-auto">
            <strong>Total items:</strong> @report.TotalItemsSold
        </div>
        <div class="col-auto">
            <strong>Date:</strong> @(report.ReportDate?.ToString("yyyy-MM-dd") ?? "-")
        </div>
    </div>

    <table class="table table-sm table-striped">
        <thead>
            <tr>
                <th>Product</th>
                <th class="text-end">Qty</th>
                <th class="text-end">Unit price</th>
                <th class="text-end">Subtotal</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var item in report.InventoryItems)
        {
            <tr>
                <td>@item.ProductName</td>
                <td class="text-end">@item.QuantitySold</td>
                <td class="text-end">@item.UnitPrice.ToString("0.00", CultureInfo.InvariantCulture)</td>
                <td class="text-end">@item.Subtotal.ToString("0.00", CultureInfo.InvariantCulture)</td>
            </tr>
        }
        </tbody>
    </table>
}

@code {
    private DateTime? selectedDate = DateTime.Today;
    private InventoryReportDto? report;
    private bool loading;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        loading = true;
        error = null;
        var result = await Api.GetDailyInventoryAsync(selectedDate);
        loading = false;

        if (!result.Success)
            error = string.Join("; ", result.Errors);
        else
            report = result.Value!;
    }
}